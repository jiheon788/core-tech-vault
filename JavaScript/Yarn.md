# Yarn
Yarn은 자바스크립트 프로젝트 의존성 관리하는 패키지 관리자이다.

### npm보다 yarn 이 빠른이유
- Yarn은 [[package.json]]의 의존성 패키지를 병렬로 다운로드하고 설치. 
- 반면, 이전의 NPM 버전은 의존성을 순차적으로 처리했기 때문에 설치 시간이 더 길었다. 
- NPM도 이후 버전에서 병렬 설치를 지원하게 되었지만, Yarn이 초기부터 이 방식을 적용하여 속도에서 우위를 점했음

### Yarn과 Yarn berry

>[!tip] node_modules의 문제 (yarn 1.x와 npm 모두에 해당)
>
>- 파일 시스템을 이용한 의존성 관리: 
>	- 라이브러리를 찾기 위해 계속 상위 디렉토리의 node_modules를 탐색해야함
>	- 메모리 상에서 자료구조로 처리하지 않고 느린 I/O 호출을 사용하기에 최적화 불가능
>- 환경에 따라 달라지는 동작
>	- 환경마다 서브 의존성이 달라질 수 있음
>- 유령 의존성 (Phantom Dependency)
>	- 속도문제를 개선하기 위기 호이스팅으로 최적화 하였으나 이로인해 발생한 사이드 이펙트 
>	- 직접 설치하지 않았으나 간접적으로 설치된 종속성에 접근할 수 있게되는 상황 (존재하지 않는 종속성에 의존)

- **Yarn (1.x)**
    - `node_modules` 폴더를 사용하여 모든 패키지를 설치하고, 프로젝트 루트에 의존성 파일을 저장하는 전통적인 방식
    - 의존성 호이스팅: 중복 의존성 설치 방지
- **Yarn Berry (Yarn 2.x ~)**
	- node_modules의 문제 개선 (상단 참고)
	-  Plug’n’Play (PnP): 
		- node_modules에 패키지 파일을 저장하는 대신 패키지의 압축 파일을 `.yarn/cache` 폴더에 **수평적**으로 저장 -> 모든 패키지에 대한 접근 시간이 O(1)
			- .yarn/cache: 의존성 정보 저장
			- .pnp.cjs: 의존성 찾을 수 있는 정보 -> 디스크 I/O없이 위치 바로 알 수 있음
		- 압축 파일은 ZipFS를 이용하며 런타임에 필요할 때 메모리에서 압축 해제하여 접근
		- 빠른 설치:
			- 압축 파일 단위로 설치되기 때문에 의존성을 구성하는 파일의 수가 절대적으로 감소
			- zero-install 전략: 하나의 압축 파일로 의존성을 관리하고, 파일을 git으로 관리
				- 아예 설치 과정 생략 -> 다른 브랜치에서 새로운 의존성이 설치되었을 때 설치 과정 없이 바로 사용, CI 실행시간 감소
				- 어떤 설치 환경에서든 같은 상황임을 명시적으로 보장
				- 브랜치를 체크아웃할 때마다 .yarn/cache 폴더에 있는 의존성도 커밋으로 잡혀있기 때문에 여타 파일들처럼 파일로 취급되어 함께 변경되기 때문에 yarn install 필요 없음
		- 빠른 검색: 
			- `.yarn/cache`에 수평적으로 존재하므로 모든 패키지에 대한 접근 시간이 O(1) -> `require()`에 소요되는 시간이 크게 단축
		- 유령 의존성 방지: 
			- nohoist 옵션 디폴트

---
### Ref
- 토스 yarn berry: https://toss.tech/article/node-modules-and-yarn-berry
- 리멤버 yarn berry 도입기: https://blog.dramancompany.com/2023/02/%EB%A6%AC%EB%A9%A4%EB%B2%84-%EC%9B%B9-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%A2%8C%EC%B6%A9%EC%9A%B0%EB%8F%8C-yarn-berry-%EB%8F%84%EC%9E%85%EA%B8%B0/